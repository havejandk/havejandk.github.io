<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
<head>
<title>Havejan, Stubfr√¶sning</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" type="text/css" href="index.css" type="text/css">
<link rel="stylesheet" type="text/css" href="lib/jquery.fancybox/jquery.fancybox.css" media="screen" />
<script type="text/javascript" src="lib/css_browser_selector.js"></script>
<link rel="stylesheet" type="text/css" href="lib/jquery.jcarousel/jquery.jcarousel.css" /> </head>
<link rel="stylesheet" type="text/css" href="lib/jquery.jcarousel/skins/tango/skin.css" /> </head>
<link rel="stylesheet" type="text/css" href="skin.css" />
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-34840994-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</head>

<body>

<div class="pagelinks">
<div class="first">
<a class="first" href="index.html">Forside</a>
</div>
<div class="rest">
<a href="Stubfr√¶sning.html">Stubfr√¶sning</a>
<a href="Beplantning.html">Beplantning</a>
<a href="Ild og Vand.html">Ild og Vand</a>
<a href="Terraenmure.html">Terr√¶nmure</a>
<a href="Traearbejde.html">Tr√¶arbejde</a>
<a href="Terrasser.html">Terrasser</a>
</div>
</div>

<div id="top">
<h1>Stubfr√¶sning</h1>
    <p>Kontakt Havejan for aftale om stubfr√¶sning. Du kan lave dit eget overslag her. Mindstepris er kr. 625.-</p>
    <template id="stump_template">
        <tr>
            <td style="flex: 1 0 auto; min-width: 5em;">ü™µStub</td>
            <td class="nowrap" style="flex: 1 0 auto; min-width: 7em;">
                <button onclick="diag_change(this, -5)">-</button>
                <input type="number" value="10" min="10" max="150" step="5" class="diag" style="width: 3em;" name="stub" />
                <button onclick="diag_change(this, 5)">+</button>
            </td>
            <td class="stump sub" style="min-width: 6em; max-width: 8em;"></td>
            <td style="width: 2em;"><button onclick="removeStump(this)" >X</button></td>
        </tr>
    </template>

    <div>
        <div class="padbox" style="min-width: 40%;">
            <table style="max-width: 30em;">
                <thead>
                    <tr>
                        <th scope="col"></th>
                        <th scope="col">Diameter<br>(cm)</th>
                        <th scope="col">Pris<br>(dkk)</th>
                        <th scope="col"></th>
                    </tr>
                </thead>
                <tbody id="price_estimate">
                    <tr class="total">
                        <td>Total</td>
                        <td></td>
                        <td id="total"></td>
                        <td></td>
                    </tr>
                    <tr id="insert_stump_point">
                        <td colspan="4"><button onclick="addStump()">Tilf√∏j stub</button></td>
                    </tr>
                    <tr>
                        <td colspan="2">Opstart (incl. 20km)</td>
                        <td class="sub">375</td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div style="max-width: 50em;">
            <ol>
                <li>M√•l dine stubbe, som du kan se p√• billederne.</li>
                <li>Tilf√∏j stubbe ved at trykke "+" og taste m√•lene</li>
                <li>Kontakt Havejan, ved at klikke her:
                    <ul class="a-buttons icon">
                        <li><a href="mailto:jan@havejan.dk" id="stub-email"><span class="icon">‚úâ</span>Email til jan@havejan.dk</a></li>
                        <li><a href="sms:+4528144464" id="stub-sms"><span class="icon">üí¨</span>Send SMS til 28 14 44 64</a></li>
                        <li><a href="tel:+4528144464"><span class="icon">üìû</span>Ring 28 14 44 64 og fort√¶l m√•lene</a></li>
                        <li class="share hidden"><a onclick="share(this)">
                            <span class="icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <circle cx="18" cy="5" r="3"></circle>
  <circle cx="6" cy="12" r="3"></circle>
  <circle cx="18" cy="19" r="3"></circle>
  <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
  <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
</svg>
</span>
Del via Web Share (find selv jan@havejan.dk, eller 28 14 44 64)
</a>
                        </li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>
    <div class="staticimages">
        <img src="album/Stubfr√¶sning/stump_70cm.jpg"  />
        <img src="album/Stubfr√¶sning/stump_86cm.jpg"  />
        <img src="album/Stubfr√¶sning/gigant_stump.jpg"  />
        <img src="album/Stubfr√¶sning/stump_50cm.jpg"  />
        <img src="album/Stubfr√¶sning/stump_78cm.jpg"  />
        <img src="album/Stubfr√¶sning/stub_fraeser_i_kran.jpg"  />
    </div>
</div>

</body>
    <script>
        const min_diag = 10;
        const phoneNumber = "+4528144464";
        const email = 'jan@havejan.dk';
        const maxPris = 625;

        function makeParseFloatLocal(locale = undefined) {
            const formatter = Intl.NumberFormat(locale);
            const groupSep = formatter.format(111111).replace(/\p{Number}/gu, '');
            const decimalSep = formatter.format(1.1).replace(/\p{Number}/gu, '');
            replaceGroupSep = groupSep == '' ? null : new RegExp(`\\${groupSep}`, 'g');
            replaceDecimalSep = decimalSep == '' ? null : new RegExp(`\\${decimalSep}`);
            if (replaceGroupSep == null)
                if ( replaceDecimalSep == null )
                    return parseFloat;
                else
                    return (str => parseFloat(str.replace(replaceDecimalSep, '.')));
            else if (replaceDecimalSep == null )
                return (str => parseFloat(str.replace(replaceGroupSep, '')));
            else
                return (str => parseFloat(str.replace(replaceGroupSep, '').replace(replaceDecimalSep, '.')))
        };
        parseFloatLocal = makeParseFloatLocal();
        function textMoney(value) {
            if (isNaN(value) || value === undefined || value == null || value < 0 || value > 1000000)
                return "FEJL";
            return value.toLocaleString(undefined, {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        };
        function diagNode(node) {
            if (node.classList.contains("diag"))
                return node;
            return node.querySelector(".diag");
        };
        function diagSet(node, val) {
            const dnode = diagNode(node);
            if ( dnode === undefined)
                return;
            dnode.value = textMoney(val);
            return node;
        };
        function diagValue(node) {
            const v = diagNode(node).value;
            const d = parseFloatLocal(v);
            if (d < 10)
                return 10;
            if (d > 500)
                return 500;
            return d;
        };
        function subNode(node) {
            if (node.classList.contains("sub"))
                return node;
            return node.querySelector(".sub");
        };
        function setPrice(node) {
            const d = diagValue(node);
            const price = d * d * .1;
            subNode(node).textContent = textMoney(price);
        };
        function priceEstimateNode() {
            return document.querySelector("#price_estimate");
        };
        function calculateMessage() {
            const stubs = [...document.querySelectorAll(".diag")];
            const count = stubs.length;
            const diagList = stubs
                .map(x => `${x.value}cm`)
                .reduce((acc, val) => `${acc}\n${val}`);
            const word_stubbe = count == 1 ? 'stub' : 'stubbe';
            const msg = {
                'subject': `Stubfraesning af ${count} ${word_stubbe}`,
                'body': `Hej Havejan, Jeg vil gerne kontaktes om ${count} ${word_stubbe}:\n${diagList}`
            };
            return msg;
        };
        async function share(node) {
            msg = calculateMessage();
            const shareData = {
                title: msg.subject,
                text: msg.body
            };
            try {
                await navigator.share(shareData);
            } catch(err) {
                console.log("failed share");
            }

        }
        function makeUpdateBodies() {
            smsNode = document.querySelector("#stub-sms");
            emailNode = document.querySelector("#stub-email");
            const separator = /iPhone|iPad|iPod/i.test(navigator.userAgent) ? '&' : '?';
            function updateBodies() {
                msg = calculateMessage();
                emailNode.setAttribute('href', `mailto:${email}?subject=${encodeURIComponent(msg.subject)}&body=${encodeURIComponent(msg.body)}`);
                smsNode.setAttribute('href', `sms:${phoneNumber}${separator}body=${encodeURIComponent(`${msg.subject}: ${msg.body}`)}`);
            };
            return updateBodies;
        }
        updateBodies = makeUpdateBodies();

        function init_updateListener() {
            const table = document.querySelector("#price_estimate");
            function inputEventListener(event) {
                const target = event.target;
                if (target.classList.contains("diag")) {
                    setPrice(target.closest("tr"));
                    updateTotal();
                }
            }
            function isNodeAddedOrRemoved(mutationEvent) {
                if  (mutationEvent.type != 'childList')
                    return false;
                if (mutationEvent.addedNodes.length > 0)
                    return true;
                if (mutationEvent.removedNodes.length > 0)
                    return true;
                return false;
            }
            function isNodesAddedOrRemoved(mutationList) {
                for (const i in mutationList)
                    if (isNodeAddedOrRemoved(mutationList[i]))
                        return true;
                return false;
            }

            function priceRowAddition(mutationList) {
                if (!isNodesAddedOrRemoved(mutationList))
                    return;
                mutationList.forEach(e => e.addedNodes.forEach(updateCost))
                updateTotal();
            }
            const priceRowAdditionObserver = new MutationObserver(priceRowAddition);
            priceRowAdditionObserver.observe(priceEstimateNode(), { childList: true });
            table.addEventListener('input', inputEventListener);
        };
        
        function addStump() {
            const template = document.querySelector("#stump_template").content.cloneNode(true);
            const anchor = document.querySelector("#insert_stump_point");
            anchor.parentNode.insertBefore(template, anchor.nextSibling);
        };
        function removeStump(node) {
            node.closest("tr").remove();
        }
        function diag_change(node, val) {
            const line = node.closest("tr");
            const input = diagNode(line);
            const current = diagValue(input);
            const newValue = current + val;
            diagSet(input, newValue);
            setPrice(line);
            updateTotal();
        }
        function updateCost() {
            const stump_diags = document.querySelectorAll(".diag")
            return stump_diags.forEach(node => setPrice(node.closest("tr")))
        }
        function updateTotal() {
            var total = [...document.querySelectorAll('.sub')]
                        .map(el => parseFloatLocal(el.textContent) )
                        .reduce((acc, val) => acc + val, 0);
            if (total < maxPris) {
                total = maxPris;
            }
            document.getElementById("total").textContent = textMoney(total);
            updateBodies();
        };
        function init_share() {
            if (!navigator.share)
                document.querySelector("body").classList.add("share-unsupported");
        }
        function init() {
            init_share();
            init_updateListener();
            addStump();
        };
        document.addEventListener('DOMContentLoaded', init);
    </script>

</html>
