<!doctype html>

<html lang="dk">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta charset="UTF-8">
    <meta name="version-id" content="$Id$">
    <title>Havejan StubfrÃ¦sning</title>
  </head>
  <style>
input.diag {
    display: inline-flex;
    align-items: right;
    border: none;
    direction: rtl;
    appearance: textfield;
    -moz-appearance: textfield; /* hide Firefox arrows */
}

input.diag::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;  
}

/* Make sure buttons, inputs etc. stay finger-friendly */
button,
input,
select,
textarea,
a {
  font-size: 1rem;               /* will be 18.75px on mobile */
  min-height: 44px;              /* very important for touch targets */
  padding: 0.5em 1em;
  touch-action: manipulation; /* better mobile feel */
}
.hidden {
    visibility: hidden;
}
button {
    min-width: 1.5em;
}
input {
    min-width: auto;
}

body {
    font-size: 150%;
}
body * {
    font-size: inherit;
}
table:has(#price_estimate) {
    width: 100%;
    border-collapse: collapse;
}
table:has(#price_estimate) tr th,
table:has(#price_estimate) tr td{
    border-bottom: 2px solid #00000050;
}
tr.total {
    padding: 5px;
    margin: 10px;
    background: #00FF0010;
}
tr.total {
    font-weight: bold;
}
#price_estimate > .total {
    border-bottom: 5px double black;
}
#price_estimate tr td:nth-child(1) {
    text-align: left;
}
#price_estimate tr td {
    text-align: right;
}

.nowrap {
    display: flex;
    flex-wrap: nowrap;
}
.td {
    width: auto;
}
.padbox {
    padding: 2em;
}
.wrap-right {
    float: right;
    margin: .5em;
}
body.share-unsupported .share {
    display: none;
}
ul.icon {
    list-style: none;
    padding: 0;
}
ul.icon > li {
    margin-bottom: -.5em;
}
ul.icon > li > a
{
    display: grid;
    grid-template-columns: 24px 1fr;
    align-items: center;
    text-decoration: none;
    padding: .1em 0em;
    border-radius: 4px;
}
ul.icon > li > a > span.icon,
ul.icon > li > a > span.icon
{
    display: flex;
    justify-content: center;
    font-size: 1.2rem;
}

  </style>

  <body>

    <h1>
        Overslag pÃ¥ StubfrÃ¦sning
    </h1>

    <template id="stump_template">
        <tr>
            <td style="flex: 1 1 auto; min-width: 8em;">ðŸªµStub</td>
            <td class="nowrap">
                <button onclick="diag_change(this, -1)">-</button>
                <input type="number" value="10" min="10" max="100" step="1" class="diag" style="width: 2em;" />
                <button onclick="diag_change(this, 1)">+</button>
            </td>
            <td class="stump sub" style="min-width: 6em; max-width: 8em;"></td>
            <td style="width: 2em;"><button onclick="removeStump(this)" >ðŸ—™</button></td>
        </tr>
    </template>

    <div>
        <img src="img/stump_70cm.jpg" class="wrap-right" style="max-width: 15em; height: auto;" />
        <div class="padbox" style="min-width: 40%;">
            <table style="max-width: 25em;">
                <thead>
                    <tr>
                        <th scope="col"></th>
                        <th scope="col" style="min-width: 10em;">Diameter<br>(cm)</th>
                        <th scope="col">Pris<br>(dkk)</th>
                        <th scope="col"></th>
                    </tr>
                </thead>
                <tbody id="price_estimate">
                    <tr class="total">
                        <td>Total</td>
                        <td></td>
                        <td id="total"></td>
                        <td><button onclick="addStump()">+</button></td>
                    </tr>
                    <tr id="insert_stump_point"></tr>
                    <tr>
                        <td>Opstart</td>
                        <td></td>
                        <td class="sub">300</td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div style="max-width: 50em;">
            <ol>
                <li>MÃ¥l dine stubbe</li>
                <li>TilfÃ¸j stubbe ved at trykke "+" og taste mÃ¥lene</li>
                <li>Kontakt Havejan, enten med:
                    <ul class="li-buttons icon">
                        <li><a href="mailto:jan@havejan.dk" id="stub-email"><span class="icon">âœ‰</span>Email til jan@havejan.dk</a></li>
                        <li><a href="sms:+4528144464" id="stub-sms"><span class="icon">ðŸ’¬</span>Send SMS til 28 14 44 64</a></li>
                        <li><a href="tel:+4528144464"><span class="icon">ðŸ“ž</span>Ring 28 14 44 64 og fortÃ¦l mÃ¥lene</a></li>
                        <li class="share hidden"><a onclick="share(this)">
                            <span class="icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <circle cx="18" cy="5" r="3"></circle>
  <circle cx="6" cy="12" r="3"></circle>
  <circle cx="18" cy="19" r="3"></circle>
  <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
  <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
</svg>
</span>
Del via Web Share (find selv jan@havejan.dk, eller 28 14 44 64)
</a>
                        </li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>
</body>

    <script>
        const min_diag = 10;
        const phoneNumber = "+4528144464";
        const email = 'jan@havejan.dk';

        function makeParseFloatLocal(locale = undefined) {
            const formatter = Intl.NumberFormat(locale);
            const groupSep = formatter.format(111111).replace(/\p{Number}/gu, '');
            const decimalSep = formatter.format(1.1).replace(/\p{Number}/gu, '');
            replaceGroupSep = groupSep == '' ? null : new RegExp(`\\${groupSep}`, 'g');
            replaceDecimalSep = decimalSep == '' ? null : new RegExp(`\\${decimalSep}`);
            if (replaceGroupSep == null)
                if ( replaceDecimalSep == null )
                    return parseFloat;
                else
                    return (str => parseFloat(str.replace(replaceDecimalSep, '.')));
            else if (replaceDecimalSep == null )
                return (str => parseFloat(str.replace(replaceGroupSep, '')));
            else
                return (str => parseFloat(str.replace(replaceGroupSep, '').replace(replaceDecimalSep, '.')))
        };
        parseFloatLocal = makeParseFloatLocal();
        function textMoney(value) {
            if (isNaN(value) || value === undefined || value == null || value < 0 || value > 1000000)
                return "FEJL";
            return value.toLocaleString(undefined, {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        };
        function diagNode(node) {
            if (node.classList.contains("diag"))
                return node;
            return node.querySelector(".diag");
        };
        function diagSet(node, val) {
            const dnode = diagNode(node);
            if ( dnode === undefined)
                return;
            dnode.value = textMoney(val);
            return node;
        };
        function diagValue(node) {
            const v = diagNode(node).value;
            const d = parseFloatLocal(v);
            if (d < 10)
                return 10;
            if (d > 500)
                return 500;
            return d;
        };
        function subNode(node) {
            if (node.classList.contains("sub"))
                return node;
            return node.querySelector(".sub");
        };
        function setPrice(node) {
            const d = diagValue(node);
            const price = d * d * .1;
            subNode(node).textContent = textMoney(price);
        };
        function priceEstimateNode() {
            return document.querySelector("#price_estimate");
        };
        function calculateMessage() {
            const stubs = [...document.querySelectorAll(".diag")];
            const count = stubs.length;
            const diagList = stubs
                .map(x => `${x.value}cm`)
                .reduce((acc, val) => `${acc}\n${val}`);
            const word_stubbe = count == 1 ? 'stub' : 'stubbe';
            const msg = {
                'subject': `Stubfraesning af ${count} ${word_stubbe}`,
                'body': `Hej Havejan, Jeg vil gerne kontaktes om ${count} ${word_stubbe}:\n${diagList}`
            };
            return msg;
        };
        async function share(node) {
            msg = calculateMessage();
            const shareData = {
                title: msg.subject,
                text: msg.body
            };
            try {
                await navigator.share(shareData);
            } catch(err) {
                console.log("failed share");
            }

        }
        function makeUpdateBodies() {
            smsNode = document.querySelector("#stub-sms");
            emailNode = document.querySelector("#stub-email");
            const separator = /iPhone|iPad|iPod/i.test(navigator.userAgent) ? '&' : '?';
            function updateBodies() {
                msg = calculateMessage();
                emailNode.setAttribute('href', `mailto:${email}?subject=${encodeURIComponent(msg.subject)}&body=${encodeURIComponent(msg.body)}`);
                smsNode.setAttribute('href', `sms:${phoneNumber}${separator}body=${encodeURIComponent(`${msg.subject}: ${msg.body}`)}`);
            };
            return updateBodies;
        }
        updateBodies = makeUpdateBodies();

        function init_updateListener() {
            const table = document.querySelector("#price_estimate");
            function inputEventListener(event) {
                const target = event.target;
                if (target.classList.contains("diag")) {
                    setPrice(target.closest("tr"));
                    updateTotal();
                }
            }
            function isNodeAddedOrRemoved(mutationEvent) {
                if  (mutationEvent.type != 'childList')
                    return false;
                if (mutationEvent.addedNodes.length > 0)
                    return true;
                if (mutationEvent.removedNodes.length > 0)
                    return true;
                return false;
            }
            function isNodesAddedOrRemoved(mutationList) {
                for (const i in mutationList)
                    if (isNodeAddedOrRemoved(mutationList[i]))
                        return true;
                return false;
            }

            function priceRowAddition(mutationList) {
                if (!isNodesAddedOrRemoved(mutationList))
                    return;
                mutationList.forEach(e => e.addedNodes.forEach(updateCost))
                updateTotal();
            }
            const priceRowAdditionObserver = new MutationObserver(priceRowAddition);
            priceRowAdditionObserver.observe(priceEstimateNode(), { childList: true });
            table.addEventListener('input', inputEventListener);
        };
        
        function addStump() {
            const template = document.querySelector("#stump_template").content.cloneNode(true);
            const anchor = document.querySelector("#insert_stump_point");
            anchor.parentNode.insertBefore(template, anchor.nextSibling);
        };
        function removeStump(node) {
            node.closest("tr").remove();
        }
        function diag_change(node, val) {
            const line = node.closest("tr");
            const input = diagNode(line);
            const current = diagValue(input);
            const newValue = current + val;
            diagSet(input, newValue);
            setPrice(line);
            updateTotal();
        }
        function updateCost() {
            const stump_diags = document.querySelectorAll(".diag")
            return stump_diags.forEach(node => setPrice(node.closest("tr")))
        }
        function updateTotal() {
            const total = [...document.querySelectorAll('.sub')]
                        .map(el => parseFloatLocal(el.textContent) )
                        .reduce((acc, val) => acc + val, 0);
            document.getElementById("total").textContent = textMoney(total);
            updateBodies();
        };
        function init_share() {
            if (!navigator.share)
                document.querySelector("body").classList.add("share-unsupported");
        }
        function init() {
            init_share();
            init_updateListener();
            addStump();
        };
        document.addEventListener('DOMContentLoaded', init);
    </script>
</html>

